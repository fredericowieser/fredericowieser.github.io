<!DOCTYPE html>
<html lang="en-gb"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">6 working with data | Fred Wieser</title>
<meta property="og:title" content="6 working with data | Fred Wieser" />
<meta name="twitter:title" content="6 working with data | Fred Wieser" />
<meta itemprop="name" content="6 working with data | Fred Wieser" />
<meta name="application-name" content="6 working with data | Fred Wieser" />
<meta property="og:site_name" content="Fred Wieser" />

<meta name="description" content="Professional Problem Solver">
<meta itemprop="description" content="Professional Problem Solver" />
<meta property="og:description" content="Professional Problem Solver" />
<meta name="twitter:description" content="Professional Problem Solver" />

<meta property="og:locale" content="en-gb" />
<meta name="language" content="en-gb" />

  <link rel="alternate" hreflang="en-gb" href="http://localhost:1313/wieserpedia/asp.net/reading/architecting-modern-web-apps/6-working-with-data/" title="" />



  <meta itemprop="image" content="http://localhost:1313/" />
  <meta property="og:image" content="http://localhost:1313/" />
  <meta name="twitter:image" content="http://localhost:1313/" />
  <meta name="twitter:image:src" content="http://localhost:1313/" />





<meta name="generator" content="Hugo 0.128.0">

    

    <link rel="canonical" href="http://localhost:1313/wieserpedia/asp.net/reading/architecting-modern-web-apps/6-working-with-data/">
    <link href="/style.min.457a762023c72861206ec5bb10e1b9c48ab24b334b14f6149cddaafd400b6391.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    </head>
<body data-theme = "auto" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/projects/">
                        Projects
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/blog/">
                        Blog
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/wieserpedia/">
                        Wieserpedia
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        About
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/cv/">
                        CV
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>
<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">6 working with data</h1>
                
                
                <div class="post-meta">
                    <time datetime="2023-04-14T00:00:00-06:00" itemprop="datePublished"> 14 Apr 2023 </time>
                </div>
                
            </header>
            
            <div class="page-content">
                <h1 id="ef-core-vs-micro-orm-dapper">EF Core vs. Micro-ORM (Dapper)</h1>
<p>EF Core abstracts SQL from the developer, but also has more overhead due to translating LINQ expressions to SQL and change tracking on entities.  Dapper is more lightweight and focuses on performance.</p>
<h2 id="comparison">Comparison</h2>
<h3 id="ef-core">EF Core</h3>
<p> </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">private</span> <span style="color:#ff7b72">readonly</span> CatalogContext _context;
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">public</span> <span style="color:#ff7b72">async</span> Task&lt;IEnumerable&lt;CatalogType&gt;&gt; GetCatalogTypes()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">await</span> _context.CatalogTypes.ToListAsync();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> </p>
<h3 id="dapper">Dapper</h3>
<p> </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">private</span> <span style="color:#ff7b72">readonly</span> SqlConnection _conn;
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">public</span> <span style="color:#ff7b72">async</span> Task&lt;IEnumerable&lt;CatalogType&gt;&gt; GetCatalogTypesWithDapper()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">return</span> <span style="color:#ff7b72">await</span> _conn.QueryAsync&lt;CatalogType&gt;(<span style="color:#a5d6ff">&#34;SELECT * FROM CatalogType&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> </p>
<h1 id="sql-vs-nosql">SQL vs NoSQL</h1>
<p>Relational databases (like SQL) map objects to tables and rows.<br>
NoSQL databases (like MongoDB or Azure Cosmos DB) serialize an object graph and store the result.</p>
<h2 id="nosql">NoSQL</h2>
<ul>
<li>Benefits:
<ul>
<li>Simplicity</li>
<li>Performance</li>
<li>No locks or transactions allows for easy scaling across many machines</li>
</ul>
</li>
<li>Drawbacks
<ul>
<li>Address, and its associated Country, might be serialized as part of many stored objects.  An update to Address and/or Country would require all such objects to be updated rather than a single row.<br>
 </li>
</ul>
</li>
</ul>
<h1 id="entity-framework-for-relational-databases">Entity Framework (for relational databases)</h1>
<p>An object-relational mapper to persist objects to and from a data source.</p>
<h2 id="dbcontext">DbContext</h2>
<p>This class contains properties representing collections of entities your application will work with.<br>
Its constructor must accept a DbContextOptions<T> and pass this to the base constructor.  Example from eShopOnWeb:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">public</span> <span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">CatalogContext</span> : DbContext
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> CatalogContext(DbContextOptions&lt;CatalogContext&gt; options) : <span style="color:#ff7b72">base</span>(options)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> DbSet&lt;CatalogItem&gt; CatalogItems { <span style="color:#ff7b72">get</span>; <span style="color:#ff7b72">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> DbSet&lt;CatalogBrand&gt; CatalogBrands { <span style="color:#ff7b72">get</span>; <span style="color:#ff7b72">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> DbSet&lt;CatalogType&gt; CatalogTypes { <span style="color:#ff7b72">get</span>; <span style="color:#ff7b72">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> </p>
<h2 id="configuring">Configuring</h2>
<p>Add <code>CatalogContext</code> to the DI container and configure it to use a SQL Server database with a connection string defined in Configuration:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>builder.Services.AddDbContext&lt;CatalogContext&gt;(
</span></span><span style="display:flex;"><span>    options =&gt; options.UseSqlServer(
</span></span><span style="display:flex;"><span>        builder.Configuration.GetConnectionString(<span style="color:#a5d6ff">&#34;DefaultConnection&#34;</span>)));
</span></span></code></pre></div><p> </p>
<h3 id="use-the-in-memory-database">Use the in-memory database:</h3>
<p> </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>builder.Services.AddDbContext&lt;CatalogContext&gt;(options =&gt;
</span></span><span style="display:flex;"><span>    options.UseInMemoryDatabase());
</span></span></code></pre></div><p> </p>
<h2 id="crud-operations-on-data">CRUD Operations on Data</h2>
<p>To retrieve data, access the appropriate property and use LINQ to filter the result:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">var</span> brandItems = <span style="color:#ff7b72">await</span> _context.CatalogBrands
</span></span><span style="display:flex;"><span>    .Where(b =&gt; b.Enabled)
</span></span><span style="display:flex;"><span>    .OrderBy(b =&gt; b.Name)
</span></span><span style="display:flex;"><span>    .Select(b =&gt; <span style="color:#ff7b72">new</span> SelectListItem { <span style="color:#8b949e;font-style:italic">// Projects the result onto a SelectListItem type</span>
</span></span><span style="display:flex;"><span>        Value = b.Id, Text = b.Name })
</span></span><span style="display:flex;"><span>    .ToListAsync(); <span style="color:#8b949e;font-style:italic">// Execute the query immediately</span>
</span></span></code></pre></div><p> <br>
Add an entity to persistence:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">var</span> newBrand = <span style="color:#ff7b72">new</span> CatalogBrand() { Brand = <span style="color:#a5d6ff">&#34;Acme&#34;</span> };
</span></span><span style="display:flex;"><span>_context.Add(newBrand);
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">await</span> _context.SaveChangesAsync();
</span></span></code></pre></div><p>  <br>
Update an entity in persistence:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">var</span> existingBrand = _context.CatalogBrands.Find(<span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span>existingBrand.Brand = <span style="color:#a5d6ff">&#34;Updated Brand&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">await</span> _context.SaveChangesAsync();
</span></span></code></pre></div><p> <br>
Remove an entity from persistence:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">var</span> brandToDelete = _context.Find&lt;CatalogBrand&gt;(<span style="color:#a5d6ff">2</span>); <span style="color:#8b949e;font-style:italic">// uses an alternate syntax for Find than above</span>
</span></span><span style="display:flex;"><span>_context.CatalogBrands.Remove(brandToDelete);
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">await</span> _context.SaveChangesAsync();
</span></span></code></pre></div><p> </p>
<h2 id="fetching-related-data">Fetching Related Data</h2>
<p>When EF Core retrieves an entity, it populates the properties that are stored with that entity in the database.  However, navigation properties, such as lists of related entities, are not populated and may be set to null.  To include these properties, use eager loading, which is done with the Include extension method on the query:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// .Include requires using Microsoft.EntityFrameworkCore</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">var</span> brandsWithItems = <span style="color:#ff7b72">await</span> _context.CatalogBrands
</span></span><span style="display:flex;"><span>    .Include(b =&gt; b.Items)
</span></span><span style="display:flex;"><span>    .ToListAsync();
</span></span></code></pre></div><p> <br>
You can include subrelationships with ThenInclude.  EF Core executes this as a single query.  You can also use an overload of the Include extension method and pass a dot-separated string:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>.Include(<span style="color:#a5d6ff">&#34;Items.Products&#34;</span>)
</span></span></code></pre></div><p>You can specify the sahpe of the data to be returned including which properties to populate:</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Includes all expression-based includes</span>
</span></span><span style="display:flex;"><span>query = specification.Includes.Aggregate(query,
</span></span><span style="display:flex;"><span>            (current, include) =&gt; current.Include(include));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// Include any string-based include statements</span>
</span></span><span style="display:flex;"><span>query = specification.IncludeStrings.Aggregate(query,
</span></span><span style="display:flex;"><span>            (current, include) =&gt; current.Include(include));
</span></span></code></pre></div><p> <br>
Aside from eager loading, two other approaches are explicit loading and lazy loading.  Both should be avoided in web apps.  See <a href="https://ardalis.com/avoid-lazy-loading-entities-in-asp-net-applications">https://ardalis.com/avoid-lazy-loading-entities-in-asp-net-applications</a>.</p>
<h2 id="encapsulating-data">Encapsulating Data</h2>
<p>Domain models often expose collection navigation properties as publicly accessible list types.  This allows collaborators to manipulate the collection&rsquo;s contents.  To solve, expose read-only access to related collections and explicitly provide methods defining ways for clients to manipulate them:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">public</span> <span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">Basket</span> : BaseEntity
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> <span style="color:#ff7b72">string</span> BuyerId { <span style="color:#ff7b72">get</span>; <span style="color:#ff7b72">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">private</span> <span style="color:#ff7b72">readonly</span> List&lt;BasketItem&gt; _items = <span style="color:#ff7b72">new</span> List&lt;BasketItem&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> IReadOnlyCollection&lt;BasketItem&gt; Items =&gt; _items.AsReadOnly(); <span style="color:#8b949e;font-style:italic">// The exposed IReadOnlyCollection wraps the underlying type.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> <span style="color:#ff7b72">void</span> AddItem(<span style="color:#ff7b72">int</span> catalogItemId, <span style="color:#ff7b72">decimal</span> unitPrice, <span style="color:#ff7b72">int</span> quantity = <span style="color:#a5d6ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">var</span> existingItem = Items.FirstOrDefault(i =&gt; i.CatalogItemId == catalogItemId);
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">if</span> (existingItem == <span style="color:#79c0ff">null</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _items.Add(<span style="color:#ff7b72">new</span> BasketItem()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        CatalogItemId = catalogItemId,
</span></span><span style="display:flex;"><span>        Quantity = quantity,
</span></span><span style="display:flex;"><span>        UnitPrice = unitPrice
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">else</span> 
</span></span><span style="display:flex;"><span>    existingItem.Quantity += quantity;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> <br>
And tell EF Core to use the backing field:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">private</span> <span style="color:#ff7b72">void</span> ConfigureBasket(EntityTypeBuilder&lt;Basket&gt; builder)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">var</span> navigation = builder.Metadata.FindNavigation(nameof(Basket.Items));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    navigation.SetPropertyAccessMode(PropertyAccessMode.Field);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> <br>
You can also encapsulate data by using value objects for types that lack identity and are only distinguished by properties:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#ff7b72">private</span> <span style="color:#ff7b72">void</span> ConfigureOrder(EntityTypeBuilder&lt;Order&gt; builder)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    builder.OwnsOne(o =&gt; o.ShipToAddress);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> <br>
Consider that the <code>ShipToAddress</code> property is of type <code>Address.</code>  <code>Address</code> is a value object with several other properties (<code>Street</code>, <code>City</code>, etc).  EF Core maps the <code>Order</code> object to its table with one column per Address property and prefixes each column name with the name of the property.  The <code>Order</code> table would include columns such as <code>ShipToAddress_Street</code> and <code>ShipToAddress_City.</code></p>
<h1 id="execution-strategies-and-explicit-transactions-using-begintransaction-and-multiple-dbcontextshttpslearnmicrosoftcomen-usdotnetarchitecturemodern-web-apps-azurework-with-data-in-asp-net-core-appsexecution-strategies-and-explicit-transactions-using-begintransaction-and-multiple-dbcontexts"><a href="https://learn.microsoft.com/en-us/dotnet/architecture/modern-web-apps-azure/work-with-data-in-asp-net-core-apps#execution-strategies-and-explicit-transactions-using-begintransaction-and-multiple-dbcontexts">Execution strategies and explicit transactions using BeginTransaction and multiple DbContexts</a></h1>
<h1 id="other-persistence-options">Other Persistence Options</h1>
<p>4 Types of Azure Storage<br>
 1. Blob Storage — for unstructured text or binary data (object storage)<br>
 2. Table Storage — for structured datasets accessible via row keys<br>
 3. Queue Storage — for reliable queue-based messaging<br>
 4. File Storage — for shared file access between Azure VMs and on-prem apps</p>
<h1 id="caching">Caching</h1>
<p>Caching is storing a copy of data on the server (or another more easily-queried data store).
ASP.NET Core supports response caching (caching entire pages) and data caching (more granular caching behavior).
Avoid implementing caching logic in your data access logic or your user interface (separation of concerns).  Encapsulate caching in its own classes and use configuration to manage its behavior.</p>
<h2 id="response-caching">Response Caching</h2>
<h3 id="first-level-of-response-caching">First level of response caching</h3>
<p>Adds HTTP headers that instruct clients and proxy servers to cache responses, but does not cache anything on the server itself.
Add the ResponseCache attribute to individual controllers or actions:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>[ResponseCache(Duration = 60)]
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">public</span> IActionResult Contact()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ViewData[<span style="color:#a5d6ff">&#34;Message&#34;</span>] = <span style="color:#a5d6ff">&#34;Your contact page.&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">return</span> View(); <span style="color:#8b949e;font-style:italic">// Adds this header to the response:  Cache-Control: public,max-age=60</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="second-level-of-response-caching">Second level of response caching</h3>
<p>Cache responses on the server.<br>
Reference <code>Microsoft.AspNetCore.ResponseCaching</code> and add the Response Caching middleware:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>builder.Services.AddResponseCaching();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// other code omitted, including building the app</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app.UseResponseCaching();
</span></span></code></pre></div><p> <br>
This will automatically cache responses based on a set of conditions.</p>
<ul>
<li>By default, 200 (OK) responses via GET and HEAD methods are cached.<br>
 <br>
More information:  <a href="https://learn.microsoft.com/en-us/aspnet/core/performance/caching/middleware#conditions-for-caching">https://learn.microsoft.com/en-us/aspnet/core/performance/caching/middleware#conditions-for-caching</a><br>
 </li>
</ul>
<h2 id="data-caching">Data Caching</h2>
<p>You can cache the results of individual data queries.  Use either in-memory caching or a distributed cache.</p>
<p>Reference <code>Microsoft.Extensions.Caching.Memory</code> and add support for in-memory caching:<br>
 </p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>builder.Services.AddMemoryCache();
</span></span><span style="display:flex;"><span>builder.Services.AddMvc();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Request IMemoryCache via dependency injection to access the cache:
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">public</span> <span style="color:#ff7b72">class</span> <span style="color:#f0883e;font-weight:bold">SomeClass</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">private</span> <span style="color:#ff7b72">readonly</span> IMemoryCache _cache;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff7b72">public</span> SomeClass(IMemoryCache cache) {
</span></span><span style="display:flex;"><span>        _cache = cache;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> </p>
<h2 id="avoiding-stale-caches">Avoiding Stale Caches</h2>
<p>When data has changed at the source but an out-of-date version remains in the cache, the cache is stale.<br>
This is avoided by:</p>
<ol>
<li>Using small cache durations (like 60 seconds)</li>
<li>Proactively removing cache entries when the data they contain is updated: <code>_cache.Remove(cacheKey);</code><br>
 <br>
If many different cache entries depend on a particular set of data, it may be useful to create dependencies between the entries using a <code>CancellationChangeToken</code>.  This allows you to expire multiple caches at once:<br>
 </li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// configure CancellationToken and add entry to cache</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">var</span> cts = <span style="color:#ff7b72">new</span> CancellationTokenSource();
</span></span><span style="display:flex;"><span>_cache.Set(<span style="color:#a5d6ff">&#34;cts&#34;</span>, cts);
</span></span><span style="display:flex;"><span>_cache.Set(cacheKey, itemToCache, <span style="color:#ff7b72">new</span> CancellationChangeToken(cts.Token));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// elsewhere, expire the cache by cancelling the token\</span>
</span></span><span style="display:flex;"><span>_cache.Get&lt;CancellationTokenSource&gt;(<span style="color:#a5d6ff">&#34;cts&#34;</span>).Cancel();
</span></span></code></pre></div><p> </p>
<h1 id="getting-data-to-blazor-wasm-apps">Getting Data to Blazor WASM Apps</h1>
<p>This is generally done through web API endpoints.  See the BlazorAdmin project in eShopOnWeb.</p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/fredericowieser" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://twitter.com/fredericowieser" target="_blank" rel="noopener noreferrer me"
    title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="https://www.youtube.com/channel/UCl3L6n0BcAsESYhQSx2uomg" target="_blank" rel="noopener noreferrer me"
    title="Youtube">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>
</a>
<a href="mailto:frederico.wieser@uclmail.net" target="_blank" rel="noopener noreferrer me"
    title="Email">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
    <polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
<a href="https://www.linkedin.com/in/frederico-wieser/" target="_blank" rel="noopener noreferrer me"
    title="Linkedin">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
    <rect x="2" y="9" width="4" height="12"></rect>
    <circle cx="4" cy="4" r="2"></circle>
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2024 Fred Wieser.
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
